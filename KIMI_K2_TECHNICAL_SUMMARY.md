# Technical Summary for Kimi K2: TankFindr "Unknown" Classification Issue

**Prepared by:** Manus AI
**Date:** November 25, 2025

## 1. Executive Summary

The TankFindr application is experiencing a high rate of "unknown" classifications for property report queries, despite having a substantial database of septic tank records. This document outlines the root causes of this issue, the current state of the database, and recommended solutions for Kimi K2 to implement.

The primary issues are:

1.  **Empty `septic_sources` Table**: The core lookup logic relies on a `septic_sources` table to determine if a location is covered by our data. This table is currently empty, causing all coverage checks to fail and fall back to less reliable methods.
2.  **Inconsistent Geometries**: A significant portion of the imported data (primarily from Florida) uses a projected coordinate system instead of the required WGS 84 (latitude/longitude), making it invisible to the spatial search function.
3.  **RPC Function Timeouts**: The `find_nearest_septic_tank` PostgreSQL function is timing out in some regions (like New Mexico) due to performance issues, returning no results even when data is present.

## 2. Root Cause Analysis

### 2.1. Empty `septic_sources` Table

The `getSepticContextForLocation` function in `lib/septicLookup.ts` first checks for data coverage by querying the `septic_sources` table. As confirmed by our investigation, this table is empty. The import scripts are populating the `septic_tanks` table but not the corresponding `septic_sources` metadata table. This is the most critical issue, as it breaks the primary lookup logic.

### 2.2. Inconsistent Geometries

The `septic_tanks` table contains a `geom` column for spatial data. The `find_nearest_septic_tank` function expects this data to be in WGS 84 format (latitude/longitude). However, a large portion of the data, especially from the initial Florida import, uses a projected coordinate system. This results in coordinates like `[668521.77, 546679.22]` instead of `[-80.21, 25.84]`.

Our spatial search function, which uses `ST_DWithin` and `ST_Distance` with geography casting, cannot operate on these projected coordinates. As a result, these records are never found during a lookup.

### 2.3. RPC Function Timeouts

Even in regions with correct WGS 84 coordinates (like New Mexico), the `find_nearest_septic_tank` function is timing out. This is likely due to the large size of the `septic_tanks` table (over 100,000 records) and the computationally intensive nature of spatial queries. The function has a 10-second timeout, which is being exceeded.

## 3. Database State

-   **`septic_tanks` Table**: Contains over 100,000 records, but the exact count is difficult to determine due to query timeouts. The data is a mix of valid WGS 84 coordinates and invalid projected coordinates.
-   **`septic_sources` Table**: **EMPTY**. This is the most critical issue.
-   **`find_nearest_septic_tank` RPC Function**: Exists but is timing out in some regions.

## 4. Recommended Solutions for Kimi K2

To resolve the "unknown" classification issue, Kimi K2 should implement the following solutions:

### 4.1. Populate the `septic_sources` Table

This is the highest priority fix. A script should be created to populate the `septic_sources` table based on the data in the `septic_tanks` table. This script should:

1.  Iterate through the unique `(county, state)` pairs in `septic_tanks`.
2.  For each pair, create a new record in `septic_sources` with the appropriate metadata (name, state, county, quality, etc.).
3.  The `coverage_geom` for each source can be generated by creating a convex hull of all the points for that source using `ST_ConvexHull` and `ST_Collect`.

### 4.2. Fix Inconsistent Geometries

A data migration script needs to be created to fix the records with projected coordinates. This script should:

1.  Identify all records in `septic_tanks` where the geometry is not in WGS 84 format. This can be done by checking if the longitude is outside the range of -180 to 180.
2.  For each invalid record, use a reprojection function like `ST_Transform` to convert the coordinates from their original projected system to WGS 84. This will require identifying the original SRID for the projected data (e.g., EPSG:2236 for Florida State Plane).
3.  Update the `geom` column with the corrected WGS 84 coordinates.

### 4.3. Optimize the RPC Function

To address the timeout issue, the `find_nearest_septic_tank` function should be optimized:

1.  **Use `ST_Transform` in the Query**: Instead of reprojecting the data in the table, the RPC function can be modified to transform the input search coordinates to match the data in the table. This is a short-term fix until the data is corrected.
2.  **Increase Timeout**: The statement timeout for the function can be increased from 10 seconds to 30 seconds to allow more time for the query to complete.
3.  **Partition the Table**: For a long-term solution, the `septic_tanks` table should be partitioned by state. This will significantly reduce the amount of data that needs to be scanned for each query.

## 5. Conclusion

By addressing these three core issues, the TankFindr application will be able to accurately and reliably classify properties, significantly reducing the number of "unknown" results and providing a much better user experience. The highest priority should be given to populating the `septic_sources` table, as this will have the most immediate impact on the lookup logic.
